---
// ChatWindow.astro
---
<div 
  id="chat-window"
  class="flex-1 overflow-y-auto p-4 space-y-4"
  data-testid="chat-window"
>
  <div id="messages-container" class="space-y-4">
    <!-- Messages rendered here -->
  </div>
  <div id="scroll-anchor"></div>
</div>

<script>
  import { $activeChat, $conversations } from '../scripts/store';
  
  const container = document.getElementById('messages-container');
  
  function render() {
      const activeChatId = $activeChat.get();
      if (!container) return;
      
      if (!activeChatId) {
          container.innerHTML = '<div class="text-center text-gray-500 mt-10">Select a chat or start a new one.</div>';
          return;
      }

      const conversations = $conversations.get();
      const chat = conversations[activeChatId];
      
      if (!chat) {
          container.innerHTML = '<div class="text-center text-gray-500 mt-10">Start chatting...</div>';
          return;
      }
      
      // Simple re-render
      // Note: We are duplicating the HTML structure from MessageBubble.astro here because we are in vanilla JS.
      // Ideally we would use a framework component (React/Vue) for the ChatWindow to share the component logic.
      container.innerHTML = chat.messages.map(msg => `
        <div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}">
          <div class="max-w-[80%] rounded-2xl px-4 py-2 ${
            msg.role === 'user' 
              ? 'chat-bubble-user' 
              : 'chat-bubble-assistant'
          }">
            ${msg.content}
          </div>
        </div>
      `).join('');
  }

  // Subscribe to store
  $conversations.subscribe(render);
  $activeChat.subscribe(render);

  // Auto-scroll
  const windowEl = document.getElementById('chat-window');
  const observer = new MutationObserver(() => {
    windowEl?.scrollTo({ top: windowEl.scrollHeight, behavior: 'smooth' });
  });
  if (container) {
      observer.observe(container, { childList: true, subtree: true });
  }
</script>
